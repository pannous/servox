<!DOCTYPE html>
<html>
<head><title>WASM GC String Test</title></head>
<body>
  <h1>WASM GC String Test</h1>
  <div id="log"></div>

  <script type="text/wast">
(module
  (type $string (array (mut i8)))
  (type $Box (struct (field $val (mut (ref $string)))))

  (data $hello "hello")

  (global $box (export "box") (mut (ref null $Box)) (ref.null $Box))

  (func $init
    ;; Create string array from passive data segment $hello
    i32.const 0
    i32.const 5
    array.new_data $string $hello
    ;; Wrap in Box struct
    struct.new $Box
    ;; Store in global
    global.set $box
  )

  (func $Box.new (export "newBox") (param (ref $string)) (result (ref $Box))
    local.get 0
    struct.new $Box
  )

  ;; Getter for box.val field (field index 0)
  (func (export "get_val") (param $box (ref $Box)) (result (ref $string))
    local.get $box
    struct.get $Box $val
  )

  ;; Setter for box.val field (field index 0)
  (func (export "set_val") (param $box (ref $Box)) (param $newval (ref $string))
    local.get $box
    local.get $newval
    struct.set $Box $val
  )

  ;; String constructor helper - create from length and fill with zeros
  ;; JS will need to fill it byte by byte
  (func (export "newString") (param $length i32) (result (ref $string))
    i32.const 0  ;; Fill value
    local.get $length  ;; Count
    array.new $string
  )

  ;; Set a byte in a string array
  (func (export "string_set_byte") (param $str (ref $string)) (param $index i32) (param $value i32)
    (local.get $str)
    (local.get $index)
    (local.get $value)
    (array.set $string)
  )

  (start $init)
)
  </script>
  <!-- Datacount section is auto-injected by wasm_compiler.rs (required for array.new_data) -->
  <script>
    function log(msg) {
      const div = document.getElementById('log');
      const p = document.createElement('p');
      p.textContent = msg;
      div.appendChild(p);
      console.log(msg);
    }

    setTimeout(() => {
      // Test toString conversion
      try {
        log('✅ Testing: "Box: " + box');
        log('Box: ' + box);  // Should work now
      } catch (e) {
        log('❌ Error: ' + e.message);
      }

      // Test box[0] access
      log('box[0] = ' + box[0]);

      if ( box[0] != "hello" ) {
        log('❌ Error: box[0] expected "hello", got ' + box[0]);
      } else {
        log('✅ box[0] correctly returned "hello"');
      }

      

      // Test setting
      box[0] = "hi";
      log('After set, box[0] = ' + box[0]);

      const box2 = window.newBox("hi");
      log('After new box2[0] = ' + box2[0]);

    }, 500);
  </script>
</body>
</html>
