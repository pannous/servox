<!DOCTYPE html>
<html>
<head><title>WASM GC Struct Test</title></head>
<body>
  <h1>Testing WASM GC Struct Access</h1>
  <div id="log"></div>

  <script type="text/wast">
(module
  ;; Simple struct with one i32 field
  (type $box (struct (field $val (mut i32))))

  ;; Create a box with a value
  (func $makeBox (export "makeBox") (param $v i32) (result (ref $box))
    local.get $v
    struct.new $box
  )
)
  </script>

  <script>
    function log(msg, level = 'log') {
      const div = document.getElementById('log');
      const p = document.createElement('p');
      p.textContent = msg;
      p.style.color = level === 'error' ? 'red' : level === 'info' ? 'blue' : 'black';
      div.appendChild(p);
      console[level](msg);
    }

    setTimeout(() => {
      log('=== WASM GC Struct Access Test ===', 'info');

      // Check if makeBox function is available
      if (typeof window.makeBox !== 'function') {
        log('❌ makeBox() function not found', 'error');
        return;
      }

      log('✅ makeBox() function available');

      try {
        // Create a box with value 42
        log('Creating box with value 42...');
        const box = window.makeBox(42);

        // Test direct string concatenation (uses toString via Proxy)
        // log('✅ Box created: ' + box); // ❌ Error: can't convert box to primitive type

        // Test direct property access by index (WASM GC uses numeric indices)
        log('Testing direct property access by index...', 'info');
        const val0 = box[0];
        log('box[0] = ' + val0, 'info');

        if (val0 === 42) {
          log('✅ SUCCESS: Got correct value from GC struct field 0!', 'info');
        } else {
          log('❌ ERROR: Expected 42, got ' + val0, 'error');
        }


        // Test direct property access by name
        log('Testing direct property access by name...', 'info');
        const val = box.val;
        log('box.val = ' + val, 'info');

        if (val === 42) {
          log('✅ SUCCESS: Got correct value from GC struct field 0!', 'info');
        } else {
          log('❌ ERROR: Expected 42, got ' + val, 'error');
        }

        // Test property setter by index
        log('Testing property setter by index...', 'info');
        box[0] = 99;
        log('Set box[0] = 99', 'info');

        const newVal = box[0];
        if (newVal === 99) {
          log('✅ SUCCESS: Property setter works! box[0] = ' + newVal, 'info');
        } else {
          log('❌ ERROR: Expected 99, got ' + newVal, 'error');
        }

        // Test toString again with new value
        log('After modification: ' + box, 'info')

      } catch (e) {
        log('❌ Error: ' + e.message, 'error');
      }
    }, 1000);
  </script>
</body>
</html>
